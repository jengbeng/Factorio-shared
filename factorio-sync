#!/usr/bin/env bash
set -euo pipefail

# ================== НАСТРОЙКИ ПО УМОЛЧАНИЮ ==================

# Папка сейвов Factorio на macOS
FACTORIO_SAVES_DIR_DEFAULT="$HOME/Library/Application Support/factorio/saves"
FACTORIO_SAVES_DIR="${FACTORIO_SAVES_DIR:-$FACTORIO_SAVES_DIR_DEFAULT}"

# Имя общего сейва в локальной папке Factorio
SHARED_SAVE_NAME="${SHARED_SAVE_NAME:-shared.zip}"

# Порт Factorio (по умолчанию 34197/UDP; тут используем для --join)
FACTORIO_PORT="${FACTORIO_PORT:-34197}"

# Интервал heartbeat-пушей (секунды)
HEARTBEAT_INTERVAL_SEC="${HEARTBEAT_INTERVAL_SEC:-180}"

# TTL статуса хоста (секунды)
HOST_TTL_SEC="${HOST_TTL_SEC:-210}"

# Корень репозитория (где лежит этот скрипт)
REPO_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$REPO_DIR"

HOST_FILE="meta/host.json"

# ================== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==================

usage() {
  cat <<EOF
Использование: $0 [команда]

Команды:
  init        - первичная настройка репозитория и GitHub
  auto        - умный режим (по умолчанию): сам подберёт роль
  host        - стать хостом (поднять сервер на этом Mac)
  play        - автоподключение или хостинг (авторежим)
  push-save   - вручную запушить сейв и пометить offline

Если команду не указать, работает как: $0 auto
EOF
}

# ---- Git / GitHub ----

git_update() {
  # Обновляем, но не валим скрипт, если есть локальные изменения
  git pull --rebase || {
    echo "git pull --rebase не удалось (возможно, есть локальные незакоммиченные изменения). Продолжаю."
  }
}

# ---- VPN (опционально: Tailscale) ----

ensure_vpn() {
  # Если tailscale не установлен — просто выходим
  if ! command -v tailscale >/dev/null 2>&1; then
    return 0
  fi

  echo "Проверяю состояние Tailscale..."
  if tailscale status >/dev/null 2>&1; then
    echo "Tailscale уже запущен."
  else
    echo "Tailscale не запущен — выполняю 'tailscale up' (однократно потребуется вход через браузер)."
    if ! tailscale up; then
      echo "Не удалось выполнить 'tailscale up'. Продолжаю без жёсткого требования VPN."
      return 0
    fi
  fi

  # Опциональная проверка, что другая сторона доступна
  if [[ -n "${FACTORIO_VPN_CHECK_HOST:-}" ]]; then
    if ping -c1 -W1 "$FACTORIO_VPN_CHECK_HOST" >/dev/null 2>&1; then
      echo "VPN-хост ${FACTORIO_VPN_CHECK_HOST} доступен."
    else
      echo "VPN-хост ${FACTORIO_VPN_CHECK_HOST} не пингуется. Возможно, другая сторона не в сети."
    fi
  fi
}

get_vpn_ip() {
  # Если tailscale есть — берём его IPv4
  if command -v tailscale >/dev/null 2>&1; then
    local ip
    ip="$(tailscale ip -4 2>/dev/null | head -n1 || true)"
    if [[ -n "$ip" ]]; then
      echo "$ip"
      return 0
    fi
  fi
  return 1
}

get_lan_ip() {
  local ip=""
  ip="$(ipconfig getifaddr en0 2>/dev/null || true)"
  if [[ -z "$ip" ]]; then
    ip="$(ipconfig getifaddr en1 2>/dev/null || true)"
  fi
  if [[ -z "$ip" ]]; then
    ip="127.0.0.1"
  fi
  echo "$ip"
}

get_host_name_simple() {
  scutil --get ComputerName 2>/dev/null || hostname
}

# ---- Работа с сейвами ----

copy_save_from_repo_to_factorio() {
  mkdir -p "$FACTORIO_SAVES_DIR"
  if [[ ! -f "saves/latest.zip" ]]; then
    echo "Внимание: файл saves/latest.zip не найден в репозитории."
    echo "Сначала кто-то должен запушить стартовый сейв."
    return 1
  fi
  cp "saves/latest.zip" "$FACTORIO_SAVES_DIR/$SHARED_SAVE_NAME"
  echo "Сейв из репозитория скопирован в:"
  echo "  $FACTORIO_SAVES_DIR/$SHARED_SAVE_NAME"
}

copy_save_from_factorio_to_repo() {
  local src="$FACTORIO_SAVES_DIR/$SHARED_SAVE_NAME"
  if [[ ! -f "$src" ]]; then
    echo "Внимание: локальный сейв \"$src\" не найден."
    echo "Убедись, что играл/сохранял именно в $SHARED_SAVE_NAME."
    return 1
  fi

  mkdir -p "saves"

  # Есть ли уже версии shared*.zip (кроме latest)?
  local existing
  existing=$(find saves -maxdepth 1 -type f -name "shared*.zip" ! -name "latest.zip" | head -n1 || true)

  local ts
  ts="$(date -u +"%Y-%m-%dT%H-%M-%SZ")"

  local version_path
  if [[ -z "$existing" ]]; then
    version_path="saves/shared.zip"
    echo "Первое сохранение: $version_path"
  else
    version_path="saves/shared_${ts}.zip"
    echo "Новая версия сохранения: $version_path"
  fi

  cp "$src" "$version_path"
  cp "$src" "saves/latest.zip"

  echo "Локальный сейв сохранён:"
  echo "  версия:  $version_path"
  echo "  latest:  saves/latest.zip"
}

# ---- host.json ----

read_host_field() {
  local key="$1"
  if [[ ! -f "$HOST_FILE" ]]; then
    return 1
  fi
  # Парсим строки вида "key": "value"
  local val
  val="$(grep -oE "\"$key\"[[:space:]]*:[[:space:]]*\"[^\"]*\"" "$HOST_FILE" 2>/dev/null \
        | sed -E "s/.*\"$key\"[[:space:]]*:[[:space:]]*\"([^\"]*)\".*/\1/" \
        | head -n1 || true)"
  if [[ -z "$val" ]]; then
    return 1
  fi
  echo "$val"
}

write_host_status() {
  local online="$1"      # "true" / "false"
  local host_name="$2"
  local vpn_ip="$3"

  mkdir -p meta

  local now_iso
  now_iso="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

  cat > "$HOST_FILE" <<EOF
{
  "online": "$online",
  "host_name": "$host_name",
  "vpn_ip": "$vpn_ip",
  "last_seen": "$now_iso"
}
EOF
}

host_is_fresh() {
  # true, если host.json говорит online=="true" и last_seen не старше TTL
  if [[ ! -f "$HOST_FILE" ]]; then
    return 1
  fi

  local online
  online="$(read_host_field "online" || true)"
  if [[ "$online" != "true" ]]; then
    return 1
  fi

  local last_seen_iso
  last_seen_iso="$(read_host_field "last_seen" || true)"
  if [[ -z "$last_seen_iso" ]]; then
    return 1
  fi

  # Переводим ISO → epoch (сек) с помощью BSD date
  local last_epoch
  if ! last_epoch="$(date -j -u -f "%Y-%m-%dT%H:%M:%SZ" "$last_seen_iso" "+%s" 2>/dev/null)"; then
    return 1
  fi
  local now_epoch
  now_epoch="$(date -u "+%s")"

  local diff=$(( now_epoch - last_epoch ))
  if (( diff <= HOST_TTL_SEC )); then
    return 0
  fi

  return 1
}

# ---- Проверка процесса Factorio ----

factorio_running() {
  pgrep -x "factorio" >/dev/null 2>&1 || pgrep -x "Factorio" >/dev/null 2>&1
}

# ================== КОМАНДЫ ==================

# ---- init ----

cmd_init() {
  echo "=== factorio-sync (macOS): init ==="
  echo "Текущая папка: $REPO_DIR"
  echo

  if [[ ! -d ".git" ]]; then
    echo "Здесь ещё нет git-репозитория. Создаю..."
    git init
    echo
  fi

  echo "Проверяю git remote origin..."
  if git remote get-url origin >/dev/null 2>&1; then
    local origin
    origin="$(git remote get-url origin)"
    echo "origin уже настроен: $origin"
  else
    echo "origin не настроен."
    read -r -p "Вставь URL репозитория на GitHub (или Enter, чтобы пропустить): " remote_url || true
    if [[ -n "${remote_url:-}" ]]; then
      git remote add origin "$remote_url"
      echo "Добавлен origin: $remote_url"
    else
      echo "origin можно настроить позже командой:"
      echo "  git remote add origin https://github.com/USER/REPO.git"
    fi
  fi

  echo
  read -r -p "Настроить сохранение GitHub-токена в macOS Keychain (рекомендуется)? [Y/n] " ans || true
  if [[ -z "$ans" || "$ans" =~ ^[Yy]$ ]]; then
    git config --global credential.helper osxkeychain || true
    echo "Глобальный credential.helper=osxkeychain установлен."
  else
    echo "Оставляю GitHub-авторизацию как есть."
  fi

  echo
  echo "Создаю служебные папки saves и meta (если ещё нет)..."
  mkdir -p saves meta
  echo "Готово."
  echo

  echo "Папка сейвов Factorio по умолчанию:"
  echo "  $FACTORIO_SAVES_DIR"
  echo "При необходимости можно переопределить переменной окружения FACTORIO_SAVES_DIR."
  echo

  echo "Дальше:"
  echo "  $0 auto        # умный режим (рекомендуется)"
  echo "  $0 host        # сразу стать хостом"
  echo "  $0 play        # авто: подключиться или стать хостом"
}

# ---- host ----

cmd_host() {
  echo "=== factorio-sync (macOS): host ==="
  echo "Папка сейвов Factorio: $FACTORIO_SAVES_DIR"
  echo

  echo "Шаг 0: VPN (если настроен Tailscale)..."
  ensure_vpn
  echo

  echo "Шаг 1: git pull..."
  git_update
  echo

  echo "Шаг 2: проверяем состояние хоста (host.json + TTL)..."
  if host_is_fresh; then
    local host_name vpn_ip last_seen
    host_name="$(read_host_field "host_name" || echo "?")"
    vpn_ip="$(read_host_field "vpn_ip" || echo "?")"
    last_seen="$(read_host_field "last_seen" || echo "?")"

    echo "Уже есть живой хост:"
    echo "  host_name : $host_name"
    echo "  vpn_ip    : $vpn_ip"
    echo "  last_seen : $last_seen"
    echo
    echo "Тебе не нужно становиться хостом. Просто подключись к этому серверу:"
    if [[ "$vpn_ip" != "?" && -n "$vpn_ip" ]]; then
      echo "  Адрес (VPN/Tailscale): $vpn_ip:$FACTORIO_PORT"
    fi
    echo
    echo "Запусти Factorio → Multiplayer → Connect to address / LAN."
    return 0
  else
    echo "Живого хоста по TTL нет. Будем становиться хостом."
  fi
  echo

  echo "Шаг 3: копируем последний сейв из репозитория в локальную папку Factorio..."
  copy_save_from_repo_to_factorio || return 1
  echo

  echo "Шаг 4: помечаем себя как online и пушим (обязательный пуш при старте)..."
  local my_host my_ip_vpn my_ip
  my_host="$(get_host_name_simple)"
  my_ip_vpn="$(get_vpn_ip || true)"
  if [[ -n "$my_ip_vpn" ]]; then
    my_ip="$my_ip_vpn"
  else
    my_ip="$(get_lan_ip)"
  fi

  write_host_status "true" "$my_host" "$my_ip"
  git add "$HOST_FILE" >/dev/null 2>&1 || true
  git commit -m "factorio-sync(mac): host ONLINE ($my_host)" >/dev/null 2>&1 || true
  git_update
  git push || true

  echo "Теперь ты помечен как хост:"
  echo "  host_name : $my_host"
  echo "  ip        : $my_ip"
  echo

  echo "Шаг 5: запускаю Factorio на сейве:"
  echo "  $FACTORIO_SAVES_DIR/$SHARED_SAVE_NAME"
  open -a "Factorio" "$FACTORIO_SAVES_DIR/$SHARED_SAVE_NAME" || {
    echo "Не удалось запустить Factorio через 'open -a Factorio'. Запусти игру вручную."
  }

  echo
  echo "Отслеживаю процесс Factorio и делаю heartbeat-пуши каждые $HEARTBEAT_INTERVAL_SEC секунд..."
  local last_hb_ts
  last_hb_ts="$(date -u "+%s")"
  local seen_running="false"

  while true; do
    if factorio_running; then
      seen_running="true"
      local now_ts diff
      now_ts="$(date -u "+%s")"
      diff=$(( now_ts - last_hb_ts ))
      if (( diff >= HEARTBEAT_INTERVAL_SEC )); then
        echo "Heartbeat: хост всё ещё онлайн, обновляем last_seen..."
        last_hb_ts="$now_ts"
        write_host_status "true" "$my_host" "$my_ip"
        git add "$HOST_FILE" >/dev/null 2>&1 || true
        git commit -m "factorio-sync(mac): host HEARTBEAT ($my_host)" >/dev/null 2>&1 || true
        git_update
        git push || true
      fi
    else
      if [[ "$seen_running" == "true" ]]; then
        echo
        echo "Factorio закрыт. Выполняю финальный пуш сейва и статуса offline..."
        # Копируем сейв обратно в репозиторий
        copy_save_from_factorio_to_repo || echo "Не удалось скопировать сейв из локальной папки."
        write_host_status "false" "$my_host" "$my_ip"
        git add saves/latest.zip "$HOST_FILE" >/dev/null 2>&1 || true
        git commit -m "factorio-sync(mac): host OFFLINE + save ($my_host)" >/dev/null 2>&1 || true
        git_update
        git push || true
        echo "Режим host завершён."
        break
      fi
    fi

    sleep 5
  done
}

# ---- push-save (ручной) ----

cmd_push_save() {
  echo "=== factorio-sync (macOS): push-save ==="
  echo "Папка сейвов Factorio: $FACTORIO_SAVES_DIR"
  echo

  copy_save_from_factorio_to_repo || return 1
  local my_host my_ip_vpn my_ip
  my_host="$(get_host_name_simple)"
  my_ip_vpn="$(get_vpn_ip || true)"
  if [[ -n "$my_ip_vpn" ]]; then
    my_ip="$my_ip_vpn"
  else
    my_ip="$(get_lan_ip)"
  fi

  write_host_status "false" "$my_host" "$my_ip"
  git add saves/latest.zip "$HOST_FILE" >/dev/null 2>&1 || true
  git commit -m "factorio-sync(mac): manual push-save ($my_host)" >/dev/null 2>&1 || true
  git_update
  git push || true

  echo
  echo "Сейв и статус offline запушены в репозиторий."
}

# ---- play (авторежим: клиент или хост) ----

cmd_play() {
  echo "=== factorio-sync (macOS): play (авторежим) ==="
  echo

  echo "Шаг 0: VPN (если настроен Tailscale)..."
  ensure_vpn
  echo

  echo "Шаг 1: git pull..."
  git_update
  echo

  echo "Шаг 2: читаем host.json..."
  local host_name vpn_ip last_seen
  if host_is_fresh; then
    host_name="$(read_host_field "host_name" || echo "?")"
    vpn_ip="$(read_host_field "vpn_ip" || echo "")"
    last_seen="$(read_host_field "last_seen" || echo "?")"

    echo "Найден живой хост:"
    echo "  host_name : $host_name"
    echo "  vpn_ip    : ${vpn_ip:-"-"}"
    echo "  last_seen : $last_seen"
    echo

    if [[ -n "$vpn_ip" ]]; then
      echo "Пробую автоматически запустить Factorio и подключиться к хосту по VPN ($vpn_ip)..."
      if open -a "Factorio" --args --join "$vpn_ip" --port "$FACTORIO_PORT" 2>/dev/null; then
        echo "Factorio запущен с параметрами подключения. Если что-то пойдёт не так — подключись вручную по адресу: $vpn_ip:$FACTORIO_PORT"
      else
        echo "Не удалось передать параметры --join в Factorio."
        echo "Подключись вручную:"
        echo "  адрес: $vpn_ip:$FACTORIO_PORT"
        echo "  Multiplayer → Connect to address"
      fi
    else
      echo "vpn_ip в host.json не задан."
      echo "Подключись по локальному списку LAN или имени хоста: $host_name"
    fi
    return 0
  else
    echo "Живого хоста по TTL нет (host.json отсутствует или устарел)."
    echo "Становимся хостом на этом Mac."
    echo
    cmd_host
  fi
}

# ---- auto (интерактивный режим) ----

cmd_auto() {
  echo "=== factorio-sync (macOS): интерактивный режим ==="
  echo

  if [[ ! -d ".git" ]]; then
    echo "В этой папке ещё нет git-репозитория."
    echo "Сначала выполни:"
    echo "  $0 init"
    return 1
  fi

  echo "Шаг 0: VPN (если настроен Tailscale)..."
  ensure_vpn
  echo

  echo "Шаг 1: git pull..."
  git_update
  echo

  echo "Шаг 2: состояние хоста:"
  local host_name vpn_ip last_seen
  local fresh="false"
  if host_is_fresh; then
    fresh="true"
    host_name="$(read_host_field "host_name" || echo "?")"
    vpn_ip="$(read_host_field "vpn_ip" || echo "-")"
    last_seen="$(read_host_field "last_seen" || echo "?")"
    echo "  host_name : $host_name"
    echo "  vpn_ip    : $vpn_ip"
    echo "  last_seen : $last_seen"
    echo "  → Хост считается ОНЛАЙН по TTL."
  else
    echo "  Живой хост не найден (host.json отсутствует или TTL истёк)."
  fi
  echo

  echo "Выбери, что сделать:"
  if [[ "$fresh" == "true" ]]; then
    echo "  1) Зайти как игрок на уже запущенный сервер."
    echo "  2) Стать хостом на этом Mac (перехватить роль)."
  else
    echo "  1) Стать хостом на этом Mac."
  fi
  echo "  3) Принудительно запушить сейв и пометить offline."
  echo "  0) Выйти."
  echo

  read -r -p "Твой выбор: " choice || true
  case "$choice" in
    1)
      if [[ "$fresh" == "true" ]]; then
        cmd_play
      else
        cmd_host
      fi
      ;;
    2)
      cmd_host
      ;;
    3)
      cmd_push_save
      ;;
    0|"")
      echo "Выход."
      ;;
    *)
      echo "Неизвестный выбор."
      ;;
  esac
}

# ================== ТОЧКА ВХОДА ==================

cmd="${1:-auto}"

case "$cmd" in
  init)
    cmd_init
    ;;
  host)
    cmd_host
    ;;
  play)
    cmd_play
    ;;
  push-save)
    cmd_push_save
    ;;
  auto)
    cmd_auto
    ;;
  *)
    usage
    exit 1
    ;;
esac