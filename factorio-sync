#!/usr/bin/env bash
set -euo pipefail

# ===== НАСТРОЙКИ ПО УМОЛЧАНИЮ =====

# Папка сейвов Factorio на macOS
FACTORIO_SAVES_DIR_DEFAULT="$HOME/Library/Application Support/factorio/saves"
FACTORIO_SAVES_DIR="${FACTORIO_SAVES_DIR:-$FACTORIO_SAVES_DIR_DEFAULT}"

# Имя общего сейва в локальной папке Factorio
SHARED_SAVE_NAME="${SHARED_SAVE_NAME:-shared.zip}"

# Порт сервера Factorio (UDP по умолчанию 34197)
FACTORIO_PORT="${FACTORIO_PORT:-34197}"

# Интервал heartbeat-пушей (сек) – раз в 3 минуты
HEARTBEAT_INTERVAL_SEC="${HEARTBEAT_INTERVAL_SEC:-180}"

# TTL статуса хоста (сек) – 3:30
HOST_TTL_SEC="${HOST_TTL_SEC:-210}"

# Корень репозитория (там, где лежит этот скрипт)
REPO_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$REPO_DIR"

# ===== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ =====

usage() {
  cat <<EOF
Использование:
  Без аргументов:       $0      - интерактивный режим (рекомендуется)
  Я хочу быть хостом:   $0 host
  Я клиент:             $0 play
  Ручной push сейва:    $0 push-save

Переменные окружения (опционально):
  FACTORIO_SAVES_DIR       - путь к папке сейвов Factorio
  SHARED_SAVE_NAME         - имя локального сейва (по умолчанию shared.zip)
  FACTORIO_PORT            - порт сервера Factorio (по умолчанию 34197)
  HEARTBEAT_INTERVAL_SEC   - интервал heartbeat-пушей (по умолчанию 180)
  HOST_TTL_SEC             - TTL статуса хоста (по умолчанию 210)
EOF
}

get_host_name() {
  # Без пробелов, чтобы удобно парсить
  local hn
  hn="$(scutil --get LocalHostName 2>/dev/null || scutil --get ComputerName 2>/dev/null || hostname)"
  echo "$hn"
}

now_utc_iso() {
  date -u +"%Y-%m-%dT%H:%M:%SZ"
}

# Копируем сейв из репозитория в локальную папку Factorio
# Всегда используем saves/latest.zip как указатель на последний сейв
copy_save_from_repo_to_factorio() {
  mkdir -p "$FACTORIO_SAVES_DIR"
  if [[ ! -f "saves/latest.zip" ]]; then
    echo "ВНИМАНИЕ: файл saves/latest.zip не найден в репозитории."
    echo "Сначала добавь туда стартовый сейв."
    return 1
  fi
  cp "saves/latest.zip" "$FACTORIO_SAVES_DIR/$SHARED_SAVE_NAME"
  echo "Сейв из репозитория скопирован в:"
  echo "  $FACTORIO_SAVES_DIR/$SHARED_SAVE_NAME"
}

# Копируем сейв из локальной папки Factorio в репозиторий
# Формат:
#   первое сохранение  -> saves/shared.zip + saves/latest.zip
#   последующие        -> saves/shared_YYYY-MM-DDTHH-MM-SSZ.zip + saves/latest.zip
copy_save_from_factorio_to_repo() {
  local src="$FACTORIO_SAVES_DIR/$SHARED_SAVE_NAME"
  if [[ ! -f "$src" ]]; then
    echo "ВНИМАНИЕ: локальный сейв \"$src\" не найден."
    echo "Убедись, что играл/сохранял именно в $SHARED_SAVE_NAME."
    return 1
  fi

  mkdir -p "saves"

  # Проверяем, есть ли уже какие-нибудь shared*.zip (кроме latest.zip)
  local existing
  existing="$(ls saves/shared*.zip 2>/dev/null | grep -v 'saves/latest.zip' || true)"

  local ts version_path
  ts="$(date -u +"%Y-%m-%dT%H-%M-%SZ")"   # UTC, безопасный для имени файла (без :)

  if [[ -z "$existing" ]]; then
    # Первое сохранение
    version_path="saves/shared.zip"
    echo "Первое сохранение: сохраняю как $version_path"
  else
    # Следующие версии
    version_path="saves/shared_${ts}.zip"
    echo "Новое сохранение: сохраняю как $version_path"
  fi

  cp "$src" "$version_path"
  # Обновляем указатель на последний сейв
  cp "$src" "saves/latest.zip"

  echo "Локальный сейв скопирован в:"
  echo "  версия:  $version_path"
  echo "  latest:  saves/latest.zip"
}

git_update() {
  git pull --rebase || true
}

read_host_status() {
  local file="meta/host.json"
  if [[ ! -f "$file" ]]; then
    return 1
  fi

  local online_raw host_raw ts_raw online host_name last_seen

  online_raw="$(grep -oE '"online"\s*:\s*(true|false)' "$file" 2>/dev/null || true)"
  host_raw="$(grep -oE '"host_name"\s*:\s*"[^"]*"' "$file" 2>/dev/null || true)"
  ts_raw="$(grep -oE '"last_seen"\s*:\s*"[^"]*"' "$file" 2>/dev/null || true)"

  if [[ -z "$online_raw" || -z "$ts_raw" ]]; then
    return 1
  fi

  online="${online_raw##*: }"
  host_name="${host_raw#*\"host_name\"*: \"}"
  host_name="${host_name%\"}"

  last_seen="${ts_raw#*\"last_seen\"*: \"}"
  last_seen="${last_seen%\"}"

  echo "$online $host_name $last_seen"
  return 0
}

write_host_status() {
  local online="$1"   # true / false
  local host_name="$2"
  local ts
  ts="$(now_utc_iso)"

  mkdir -p meta
  cat > meta/host.json <<EOF
{
  "online": $online,
  "host_name": "$host_name",
  "last_seen": "$ts"
}
EOF
}

host_status_fresh() {
  local last_seen_iso="$1"

  local now_ts host_ts
  now_ts="$(date -u +%s)"
  host_ts="$(date -u -j -f "%Y-%m-%dT%H:%M:%SZ" "$last_seen_iso" +%s 2>/dev/null || echo 0)"

  if [[ "$host_ts" -eq 0 ]]; then
    return 1
  fi

  local diff=$(( now_ts - host_ts ))
  if (( diff <= HOST_TTL_SEC )); then
    return 0
  fi
  return 1
}

factorio_running() {
  # Пытаемся поймать бинарь из .app
  if pgrep -if "Factorio.app/Contents/MacOS/factorio" >/dev/null 2>&1; then
    return 0
  fi

  # Более общий вариант: любой процесс, в имени которого есть "factorio"
  if pgrep -if "[Ff]actorio" >/dev/null 2>&1; then
    return 0
  fi

  return 1
}

# ===== ВНУТРЕННИЙ push-save (с уже известным host_name) =====

cmd_push_save_internal() {
  local host_name="$1"

  echo "=== factorio-sync: внутренний push-save ==="
  echo "Папка сейвов Factorio: $FACTORIO_SAVES_DIR"
  echo

  echo "Шаг 1: копируем локальный сейв в репозиторий..."
  copy_save_from_factorio_to_repo || true
  echo

  echo "Шаг 2: помечаем хоста как offline и пушим..."
  write_host_status "false" "$host_name"
  # Важно: добавляем всю папку saves, чтобы новые версии shared_*.zip попали в коммит
  git add saves meta/host.json || true
  git commit -m "factorio-sync: host OFFLINE + save ($host_name)" || true
  git_update
  git.push || true || git push || true

  osascript -e 'display notification "Сейв Factorio и статус (offline) запушены" with title "factorio-sync"' || true
}

# ===== КОМАНДА host =====

cmd_host() {
  echo "=== factorio-sync: режим host ==="
  echo "Папка сейвов Factorio: $FACTORIO_SAVES_DIR"
  echo

  echo "Шаг 1: git pull..."
  git_update
  echo

  echo "Шаг 2: проверяем, нет ли уже живого хоста (по TTL)..."
  local status online host_name last_seen
  if status="$(read_host_status)"; then
    online="$(echo "$status" | awk '{print $1}')"
    host_name="$(echo "$status" | awk '{print $2}')"
    last_seen="$(echo "$status" | awk '{print $3}')"

    if [[ "$online" == "true" ]] && host_status_fresh "$last_seen"; then
      echo "Сейчас уже есть живой хост:"
      echo "  host_name : $host_name"
      echo "  last_seen : $last_seen (UTC)"
      echo
      echo "Просто зайди в Factorio -> multiplayer -> LAN и подключись к этой машине."
      exit 0
    else
      echo "host.json есть, но статус offline или устарел:"
      echo "  online    : $online"
      echo "  last_seen : $last_seen (UTC)"
      echo "Считаем, что активного хоста нет."
    fi
  else
    echo "host.json нет или не читается — считаем, что активного хоста нет."
  fi
  echo

  echo "Шаг 3: копируем последний сейв из репозитория в Factorio..."
  copy_save_from_repo_to_factorio
  echo

  echo "Шаг 4: помечаем себя как online и пушим (обязательный пуш при старте)..."
  local my_host_name
  my_host_name="$(get_host_name)"
  write_host_status "true" "$my_host_name"
  git add meta/host.json || true
  git commit -m "factorio-sync: host ONLINE ($my_host_name)" || true
  git_update
  git push || true
  echo "Статус хоста (online=true) запушен."
  echo

  # Проверяем, запущен ли уже Factorio в момент запуска скрипта
  local was_running_at_start="no"
  if factorio_running; then
    was_running_at_start="yes"
    echo "Factorio уже был запущен до старта скрипта."
    echo "Не запускаю второй экземпляр, просто начинаю отслеживание."
  else
    echo "Factorio ещё не запущен. Запускаю Factorio..."
    open -n -a "Factorio" "$FACTORIO_SAVES_DIR/$SHARED_SAVE_NAME" || {
      echo "Не удалось запустить Factorio."
      exit 1
    }
  fi

  echo "Жду, пока Factorio будет запущен хотя бы один раз..."
  local has_seen_running="false"

  if [[ "$was_running_at_start" == "yes" ]]; then
    has_seen_running="true"
  fi

  if [[ "$was_running_at_start" == "no" ]]; then
    while ! factorio_running; do
      sleep 2
    done
    has_seen_running="true"
    echo "Factorio запущен. Начинай хостить игру по LAN с сейвом $SHARED_SAVE_NAME."
  else
    echo "Factorio уже запущен — отслеживание начато сразу."
  fi
  echo

  local last_hb_ts
  last_hb_ts="$(date -u +%s)"

  echo "Отслеживаю процесс и делаю heartbeat-пуши каждые $HEARTBEAT_INTERVAL_SEC секунд..."
  while true; do
    if factorio_running; then
      local now_ts
      now_ts="$(date -u +%s)"
      local diff=$(( now_ts - last_hb_ts ))
      if (( diff >= HEARTBEAT_INTERVAL_SEC )); then
        echo "Heartbeat: хост всё ещё онлайн, обновляем last_seen."
        last_hb_ts="$now_ts"
        write_host_status "true" "$my_host_name"
        git add meta/host.json || true
        git commit -m "factorio-sync: host HEARTBEAT ($my_host_name)" || true
        git_update
        git push || true
      fi
    else
      if [[ "$has_seen_running" == "true" ]]; then
        echo
        echo "Factorio был запущен и сейчас закрыт. Выполняю финальный пуш сейва и статуса offline..."
        cmd_push_save_internal "$my_host_name"
        echo "Режим host завершён."
        break
      else
        echo "Factorio ещё ни разу не был запущен. Жду..."
      fi
    fi

    sleep 5
  done
}

# ===== КОМАНДА push-save (ручной) =====

cmd_push_save() {
  echo "=== factorio-sync: режим push-save (ручной) ==="
  local host_name
  if status="$(read_host_status)"; then
    host_name="$(echo "$status" | awk '{print $2}')"
  else
    host_name="$(get_host_name)"
  fi
  cmd_push_save_internal "$host_name"
}

# ===== КОМАНДА play (клиент) =====

cmd_play() {
  echo "=== factorio-sync: режим play (клиент) ==="
  echo

  echo "Шаг 1: git pull..."
  git_update
  echo

  echo "Шаг 2: читаем host.json и проверяем TTL..."
  local status online host_name last_seen

  if status="$(read_host_status)"; then
    online="$(echo "$status" | awk '{print $1}')"
    host_name="$(echo "$status" | awk '{print $2}')"
    last_seen="$(echo "$status" | awk '{print $3}')"

    if [[ "$online" == "true" ]] && host_status_fresh "$last_seen"; then
      echo "Есть живой хост:"
      echo "  host_name : $host_name"
      echo "  last_seen : $last_seen (UTC)"
      echo
      echo "Действия:"
      echo "  1) Запусти Factorio."
      echo "  2) В мультиплеере выбери LAN и подключись к машине '$host_name'."
      exit 0
    else
      echo "host.json найден, но статус либо offline, либо устарел:"
      echo "  online    : $online"
      echo "  last_seen : $last_seen (UTC)"
      echo "Считаем, что активного хоста нет."
    fi
  else
    echo "host.json не найден или не читается — считаем, что хоста нет."
  fi

  echo
  echo "Сейчас активного хоста нет."
  echo "Кто-то из игроков должен выполнить:"
  echo "  ./factorio-sync host"
  echo "чтобы стать хостом."
}

# ===== КОМАНДА auto (интерактивный режим по умолчанию) =====

cmd_auto() {
  echo "=== factorio-sync: интерактивный режим ==="
  echo

  echo "Шаг 1: git pull..."
  git_update
  echo

  echo "Шаг 2: состояние репозитория:"
  local status online host_name last_seen
  local has_status="no"
  local fresh="no"

  if status="$(read_host_status)"; then
    has_status="yes"
    online="$(echo "$status" | awk '{print $1}')"
    host_name="$(echo "$status" | awk '{print $2}')"
    last_seen="$(echo "$status" | awk '{print $3}')"

    echo "  host_name : $host_name"
    echo "  online    : $online"
    echo "  last_seen : $last_seen (UTC)"

    if [[ "$online" == "true" ]] && host_status_fresh "$last_seen"; then
      fresh="yes"
      echo "  → По TTL: хост считается ОНЛАЙН."
    else
      echo "  → По TTL: хост считается ОФФЛАЙН или запись устарела."
    fi
  else
    echo "  host.json отсутствует — никто ещё не запускал сервер."
  fi

  echo
  echo "Что ты хочешь сделать?"

  if [[ "$fresh" == "yes" ]]; then
    echo "  1) Зайти как игрок на уже запущенный сервер."
    echo "  2) Попробовать самому стать хостом (если уверен, что сервер на самом деле выключен)."
  else
    echo "  1) Стать хостом (запустить сервер на этом компьютере)."
  fi

  echo "  3) Принудительно запушить сейв и статус offline (для этого компьютера)."
  echo "  0) Ничего не делать и выйти."
  echo

  read -rp "Выбери номер и нажми Enter: " choice

  case "$choice" in
    1)
      if [[ "$fresh" == "yes" ]]; then
        echo
        echo "Режим клиента."
        echo "Действия:"
        echo "  1) Запусти Factorio."
        echo "  2) В мультиплеере выбери LAN и подключись к машине '$host_name'."
        exit 0
      else
        echo
        echo "Запускаю режим host (сервер на этом компьютере)..."
        cmd_host
      fi
      ;;
    2)
      if [[ "$fresh" == "yes" ]]; then
        echo
        echo "Пытаюсь стать хостом, несмотря на текущую запись о живом хосте."
        echo "Убедись, что старый сервер реально выключен."
        cmd_host
      else
        echo
        echo "Активного хоста нет — пункт 2 эквивалентен 'Стать хостом'."
        cmd_host
      fi
      ;;
    3)
      echo
      cmd_push_save
      ;;
    0|q|Q)
      echo "Выход."
      ;;
    *)
      echo "Неизвестный выбор. Ничего не делаю."
      ;;
  esac
}

# ===== РАЗБОР АРГУМЕНТОВ =====

if [[ $# -lt 1 ]]; then
  cmd_auto
  exit 0
fi

case "$1" in
  auto)
    cmd_auto
    ;;
  host)
    cmd_host
    ;;
  play)
    cmd_play
    ;;
  push-save)
    cmd_push_save
    ;;
  *)
    usage
    exit 1
    ;;
esac