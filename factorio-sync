#!/usr/bin/env bash
set -euo pipefail

# ===== НАСТРОЙКИ ПО УМОЛЧАНИЮ =====

# Папка сейвов Factorio на macOS
FACTORIO_SAVES_DIR_DEFAULT="$HOME/Library/Application Support/factorio/saves"

# Можно переопределить через переменную окружения
FACTORIO_SAVES_DIR="${FACTORIO_SAVES_DIR:-$FACTORIO_SAVES_DIR_DEFAULT}"

# Имя общего сейва в локальной папке Factorio
SHARED_SAVE_NAME="${SHARED_SAVE_NAME:-shared.zip}"

# Порт Factorio (по умолчанию 34197/UDP; здесь проверяем TCP как приближение)
FACTORIO_PORT="${FACTORIO_PORT:-34197}"

# Если хочешь зафиксировать IP (например, IP VPN-сети),
# экспортируй FACTORIO_HOST_IP перед запуском.
FACT_HOST_IP_ENV="${FACTORIO_HOST_IP:-}"

# Определяем корень репозитория как папку, где лежит этот скрипт
REPO_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$REPO_DIR"

# ===== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ =====

usage() {
  cat <<EOF
Использование: $0 <команда>

Команды:
  play       - определить хоста, подтянуть последний сейв, либо стать хостом
  push-save  - залить локальный сейв (shared.zip) обратно в репозиторий

Переменные окружения (опционально):
  FACTORIO_SAVES_DIR  - путь к папке сейвов Factorio
  SHARED_SAVE_NAME    - имя локального сейва (по умолчанию shared.zip)
  FACTORIO_HOST_IP    - IP, по которому к тебе будут подключаться другие
  FACTORIO_PORT       - порт Factorio (по умолчанию 34197)
EOF
}

# Получение IP для записи в host.json
get_host_ip() {
  if [[ -n "$FACT_HOST_IP_ENV" ]]; then
    echo "$FACT_HOST_IP_ENV"
    return 0
  fi

  # Попытаться взять IP основного интерфейса Wi-Fi (en0 / en1)
  local ip=""
  ip="$(ipconfig getifaddr en0 2>/dev/null || true)"
  if [[ -z "$ip" ]]; then
    ip="$(ipconfig getifaddr en1 2>/dev/null || true)"
  fi
  if [[ -z "$ip" ]]; then
    # Фоллбек: localhost
    ip="127.0.0.1"
  fi
  echo "$ip"
}

# Чтение IP из meta/host.json без jq
read_host_ip_from_file() {
  local file="meta/host.json"
  if [[ ! -f "$file" ]]; then
    return 1
  fi
  # Простой парсинг "ip": "..."
  local ip
  ip="$(grep -oE '"ip"\s*:\s*"[^"]+"' "$file" 2>/dev/null \
        | sed 's/.*"ip"\s*:\s*"\([^"]*\)".*/\1/')"
  if [[ -z "$ip" ]]; then
    return 1
  fi
  echo "$ip"
  return 0
}

# Проверка, слушает ли кто-то порт FACTORIO_PORT на IP (примерно)
check_host_reachable() {
  local ip="$1"
  if nc -z "$ip" "$FACTORIO_PORT" 2>/dev/null; then
    return 0
  fi
  return 1
}

# Копирование сейва из репозитория в локальную папку Factorio
copy_save_from_repo_to_factorio() {
  mkdir -p "$FACTORIO_SAVES_DIR"
  if [[ ! -f "saves/latest.zip" ]]; then
    echo "ВНИМАНИЕ: файл saves/latest.zip не найден в репозитории."
    echo "Проверь, что в репо залит хотя бы один сейв."
    return 1
  fi
  cp "saves/latest.zip" "$FACTORIO_SAVES_DIR/$SHARED_SAVE_NAME"
  echo "Сейв из репозитория скопирован в:"
  echo "  $FACTORIO_SAVES_DIR/$SHARED_SAVE_NAME"
}

# Копирование сейва из локальной папки Factorio в репозиторий
copy_save_from_factorio_to_repo() {
  local src="$FACTORIO_SAVES_DIR/$SHARED_SAVE_NAME"
  if [[ ! -f "$src" ]]; then
    echo "ВНИМАНИЕ: локальный сейв \"$src\" не найден."
    echo "Убедись, что играл/сохранял именно в $SHARED_SAVE_NAME."
    return 1
  fi
  mkdir -p "saves"
  cp "$src" "saves/latest.zip"
  echo "Локальный сейв скопирован в репозиторий: saves/latest.zip"
}

# Обновить репозиторий (pull --rebase)
git_update() {
  git pull --rebase || true
}

# ===== КОМАНДА play =====

cmd_play() {
  echo "=== factorio-sync: режим play ==="
  echo "Папка сейвов Factorio: $FACTORIO_SAVES_DIR"
  echo

  echo "Шаг 1: обновляем репозиторий (git pull)..."
  git_update
  echo

  echo "Шаг 2: пробуем использовать существующего хоста (если есть)..."
  local ip_existing
  if ip_existing="$(read_host_ip_from_file)"; then
    echo "В meta/host.json указан хост: $ip_existing"
    echo "Проверяем доступность порта $FACTORIO_PORT..."
    if check_host_reachable "$ip_existing"; then
      echo
      echo "Хост доступен: $ip_existing:$FACTORIO_PORT"
      echo "Действия:"
      echo "  1) Запусти Factorio на своём Mac."
      echo "  2) В мультиплеере подключись к адресу: $ip_existing"
      exit 0
    else
      echo "Хост $ip_existing недоступен (порт закрыт или хост не в сети)."
      echo "Пробуем стать новым хостом."
    fi
  else
    echo "Файл meta/host.json отсутствует или не содержит IP."
    echo "Будем становиться первым хостом."
  fi
  echo

  echo "Шаг 3: копируем последний сейв из репозитория в локальную папку Factorio..."
  copy_save_from_repo_to_factorio
  echo

  echo "Шаг 4: определяем IP для хоста..."
  local my_ip
  my_ip="$(get_host_ip)"
  echo "Определён IP хоста: $my_ip"

  echo "Шаг 5: записываем meta/host.json и пушим (с защитой от гонок)..."
  mkdir -p meta
  cat > meta/host.json <<EOF
{
  "ip": "$my_ip"
}
EOF

  git add meta/host.json || true
  git commit -m "factorio-sync: new host $my_ip" || true

  # Попытка подтянуть возможные изменения и проверить, не появился ли другой хост
  git_update

  # После pull ещё раз читаем host.json
  local ip_after_pull
  if ip_after_pull="$(read_host_ip_from_file)"; then
    if [[ "$ip_after_pull" != "$my_ip" ]]; then
      echo
      echo "Во время обновления репозитория появился другой хост: $ip_after_pull"
      echo "Значит, мы НЕ будем перезатирать host.json."
      echo
      echo "Действия:"
      echo "  1) Запусти Factorio."
      echo "  2) Подключись к адресу: $ip_after_pull"
      exit 0
    fi
  fi

  # Если сюда дошли — считаем себя актуальным хостом
  git push || true

  echo
  echo "Теперь ТЫ хост."
  echo "Действия (автоматизированы):"
  echo "  1) Сейчас будет запущен Factorio на сейве:"
  echo "       $FACTORIO_SAVES_DIR/$SHARED_SAVE_NAME"
  echo "  2) Когда закроешь игру, сейв автоматически запушится в репозиторий."
  echo

  echo "Запускаю Factorio и жду его закрытия..."
  # -W: ждать, пока приложение завершится
  open -W -a "Factorio" "$FACTORIO_SAVES_DIR/$SHARED_SAVE_NAME" || {
    echo "Не удалось запустить Factorio через open -a."
    exit 1
  }

  echo
  echo "Factorio закрыт. Выполняю push-save..."
  "$0" push-save
}

# ===== КОМАНДА push-save =====

cmd_push_save() {
  echo "=== factorio-sync: режим push-save ==="
  echo "Папка сейвов Factorio: $FACTORIO_SAVES_DIR"
  echo

  echo "Шаг 1: копируем локальный сейв в репозиторий..."
  copy_save_from_factorio_to_repo
  echo

  echo "Шаг 2: коммитим и пушим сейв..."
  git add saves/latest.zip || true
  git commit -m "factorio-sync: update save" || true
  git_update
  git push || true

  echo
  echo "Сейв обновлён в репозитории."

  # macOS-уведомление об успешном пуше
  osascript -e 'display notification "Сейв Factorio запушен в репозиторий" with title "factorio-sync"' || true
}

# ===== РАЗБОР АРГУМЕНТОВ =====

if [[ $# -lt 1 ]]; then
  usage
  exit 1
fi

case "$1" in
  play)
    cmd_play
    ;;
  push-save)
    cmd_push_save
    ;;
  *)
    usage
    exit 1
    ;;
esac
